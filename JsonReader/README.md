# ComfyUI JSON Reader for After Effects

A powerful After Effects panel that extracts and displays generation parameters from ComfyUI images. Instantly view prompts, seeds, sampling settings, and more from any PNG generated by ComfyUI!

![JSON Reader Panel](https://raw.githubusercontent.com/ckonteos80/Adobe-After-Effects-ComfyUI-Panels/main/Screenshots/JsonReaderPanel.jpg)

## üåü Features

- **Instant Metadata Reading**: Fast PNG chunk parsing extracts ComfyUI data in milliseconds
- **Parameter Extraction**: Automatically parses and displays all generation settings
- **API Prompt Access**: View and export the API-format prompt for regeneration
- **No External Dependencies**: Pure ExtendScript implementation - no additional tools required
- **Layer Integration**: Read metadata directly from selected footage layers
- **Clipboard Support**: One-click copy of API prompt JSON
- **File Export**: Save API prompts as standalone JSON files
- **Auto-Refresh**: Monitors selected layers for instant updates

## üöÄ Installation

1. **Download** JsonReader.jsx
2. **Copy** the file to your After Effects Scripts folder:
   - **Windows**: `C:\Program Files\Adobe\Adobe After Effects [version]\Support Files\Scripts\ScriptUI Panels\`
   - **macOS**: `/Applications/Adobe After Effects [version]/Scripts/ScriptUI Panels/`
3. **Restart** After Effects
4. **Open** the panel via `Window > JsonReader.jsx`

## üìã Prerequisites

- **After Effects** CC 2018 or later
- **PNG images** generated by ComfyUI with embedded metadata

## üéØ Quick Start

1. **Open the panel** in After Effects
2. **Import a ComfyUI-generated PNG** into your project
3. **Add it to a composition** and select the layer
4. **Click "From Selected Layer"** or use Auto-Refresh
5. **View all generation parameters** in the panel

## ‚öôÔ∏è Panel Sections

### Status & Controls
- **Status**: Shows current operation and results
- **From Selected Layer**: Read metadata from currently selected footage layer
- **Browse PNG**: Select any PNG file from your file system
- **Refresh**: Manually refresh metadata from selected layer

### Action Buttons
- **Copy API Prompt**: Copy the full API JSON to clipboard
- **Save API Prompt**: Export API prompt as a JSON file

### Generation Parameters
Automatically extracted and displayed:
- **Seed**: The random seed used for generation
- **Steps**: Number of denoising steps
- **CFG**: Classifier-free guidance scale
- **Sampler**: Sampling algorithm (euler, dpmpp_2m, etc.)
- **Scheduler**: Noise scheduler (karras, exponential, etc.)
- **Size**: Image dimensions (width x height)
- **Denoise**: Denoising strength (for img2img workflows)
- **Model**: Checkpoint/model name used
- **Positive Prompt**: The main generation prompt
- **Negative Prompt**: Negative prompt text

### JSON Viewer
- **Full API Prompt**: Complete API-format JSON for regeneration
- **Syntax Highlighting**: Easy to read formatted output
- **Scrollable View**: Handle large workflow definitions

## üîç Supported Metadata

The panel reads ComfyUI metadata from PNG text chunks:
- **prompt** chunk: API-format workflow execution data
- **workflow** chunk: UI-format workflow definition (used for parameter extraction fallback)

### Extracted Node Types
- **KSampler / KSamplerAdvanced**: Sampling parameters
- **CLIPTextEncode**: Prompt text (positive and negative)
- **EmptyLatentImage**: Dimensions
- **CheckpointLoaderSimple**: Model information
- And many more node types supported

## üí° Usage Tips

### Workflow Integration
- **Project Organization**: Keep a library of successful generation parameters
- **Prompt Management**: Extract and reuse prompts from favorite generations
- **API Regeneration**: Use exported API prompts with ComfyUI's API
- **Quick Reference**: View generation settings without opening ComfyUI

### Layer Selection
- **Auto-Refresh**: Panel updates when you select different layers
- **Multi-Layer Projects**: Quickly compare settings across multiple generated images
- **Composition Preview**: See parameters while previewing your comp

### Export Options
- **Copy to Clipboard**: Paste directly into text editors or code
- **Save as JSON**: Create a library of reusable API prompts
- **API Integration**: Use exported prompts with the Image2Image panel or directly with ComfyUI

## üîß Technical Details

### PNG Chunk Parsing
- **Optimized Reading**: Only parses text chunks, skips image data
- **Binary Safe**: Properly handles UTF-8 encoded metadata
- **Format Support**: Reads tEXt, iTXt, and zTXt chunks
- **Safety Limits**: Maximum 200 chunks to prevent infinite loops

### ExtendScript Compatibility
- **Pre-ES5 Compatible**: Works with After Effects' older JavaScript engine
- **No Modern APIs**: Avoids Object.keys(), String.repeat(), etc.
- **Custom Helpers**: Implements required utility functions
- **Cross-Platform**: Works on Windows and macOS

### Performance
- **Fast Parsing**: Instant metadata extraction even on large files
- **Minimal Memory**: Efficient chunk skipping reduces memory usage
- **Non-Blocking**: UI remains responsive during operations

## üêõ Troubleshooting

### Common Issues

**"No text chunks found in PNG file"**
- Image was not generated by ComfyUI
- Metadata was stripped during export/conversion
- Use "Save image" node in ComfyUI, not screenshot/export

**"No ComfyUI workflow data found"**
- PNG contains text chunks but not ComfyUI metadata
- May be from older ComfyUI version
- Verify image was saved via ComfyUI's Save Image node

**"No API Prompt loaded"**
- Image only contains workflow data (UI format)
- Some ComfyUI configurations only save workflow, not API prompt
- Can still view extracted parameters from workflow data

**"Please select a PNG footage layer"**
- Selected layer is not a footage item
- Source file is not a PNG
- Layer has no linked file (e.g., solid color layer)

### Layer Requirements
- Must be a **Footage Item** (not solid, shape layer, text, etc.)
- Must have a **linked file** (not missing footage)
- File must be **PNG format** (.png extension)
- File must **exist on disk** (not offline)

## ü§ù Use Cases

### For Artists
- **Learn from Success**: Study what settings produced your best results
- **Consistency**: Replicate successful generation parameters
- **Documentation**: Keep records of your creative process
- **Sharing**: Export settings to share with other artists

### For Technical Users
- **API Integration**: Extract prompts for programmatic generation
- **Batch Processing**: Use saved prompts with scripts
- **Workflow Analysis**: Study node connections and parameters
- **Debugging**: Verify generation settings match expectations

### For Teams
- **Knowledge Transfer**: Share successful generation parameters
- **Style Guides**: Document approved generation settings
- **Quality Control**: Verify images match specified parameters
- **Asset Management**: Tag and organize by generation settings

## üìä Comparison with ComfyUI

| Feature | JsonReader Panel | ComfyUI UI |
|---------|------------------|------------|
| View metadata | ‚úÖ Instant | ‚úÖ Via image preview |
| Extract parameters | ‚úÖ Automatic | ‚ùå Manual inspection |
| After Effects integration | ‚úÖ Native | ‚ùå Not available |
| Copy API prompt | ‚úÖ One click | ‚úÖ Via Dev mode |
| No app switching | ‚úÖ Yes | ‚ùå Must open ComfyUI |
| Batch comparison | ‚úÖ Select layers | ‚ùå One at a time |

## üîÑ Integration with Image2Image Panel

The JsonReader panel pairs perfectly with the ComfyUI Image2Image panel:
1. **Extract settings** from a successful generation
2. **Open Image2Image panel** for new generation
3. **Manually apply settings** (seed, steps, CFG, prompts, etc.)
4. **Generate variations** based on proven parameters

## ü§ù Contributing

Contributions are welcome! Please feel free to:
- Report bugs via GitHub Issues
- Suggest new features
- Submit pull requests
- Share example workflows

## üìÑ License

This project is licensed under the MIT License - see the LICENSE file for details.

## üôè Acknowledgments

- **ComfyUI** team for embedding rich metadata in generated images
- **Adobe** for the ExtendScript scripting environment
- **PNG specification** authors for the flexible text chunk format

---

**Made with ‚ù§Ô∏è for the After Effects and AI art community**

For support and updates, visit the [GitHub repository](https://github.com/ckonteos80/AE-ComfyUI-Panels).
